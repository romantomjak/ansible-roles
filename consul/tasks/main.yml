---
# Installs Consul agent

- name: Ensure required utilities are present
  apt:
    name:
      - curl
      - gnupg2
    state: latest
    update_cache: yes
  become: true

- name: Import Hashicorp GPG key
  shell:
    cmd: "curl -fsSL {{ item.key }} | gpg --no-default-keyring --keyring gnupg-ring:/etc/apt/trusted.gpg.d/{{ item.keyring }} --import"
    creates: "/etc/apt/trusted.gpg.d/{{ item.keyring }}"
    warn: False
  with_items:
    - key: https://apt.releases.hashicorp.com/gpg
      keyring: hashicorp-archive-keyring.gpg
  become: true

- name: Fix key permissions
  file:
    path: "/etc/apt/trusted.gpg.d/{{ item }}"
    owner: root
    group: root
    mode: "u=rw,g=r,o=r"
  with_items:
    - hashicorp-archive-keyring.gpg
  become: true

- name: Add Hashicorp APT repository
  copy:
    content: >-
      deb [arch=amd64 signed-by=/etc/apt/trusted.gpg.d/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com {{ ansible_lsb.codename }} main
    dest: /etc/apt/sources.list.d/kubernetes.list
    owner: root
    group: root
    mode: "u=rw,g=r,o=r"
  become: true

- name: Install latest version of Consul
  apt: name=consul state=latest update_cache=yes
  become: true

- include_tasks: configure_tls.yml

- name: Copy agent configuration
  template:
    src: "templates/{{ consul_agent_type }}.hcl.j2"
    dest: /etc/consul.d/consul.hcl
    owner: consul
    group: consul
    mode: 0644
  become: true
  when: consul_agent_type 

- name: Start Consul
  systemd: name=consul enabled=yes state=restarted daemon_reload=true
  become: true

- name: Create agent policy
  consul_acl_policy:
    name: "{{ ansible_hostname }}"
    rules: |
      node "{{ ansible_hostname }}" {
        policy = "write"
      }
    datacenters:
      - "{{ consul_datacenter }}"
    state: present
    mgmt_token: "{{ consul_acl_initial_management_token }}"
  register: consul_acl_agent_policy_output

- name: Create agent token
  consul_acl_token:
    description: "{{ ansible_hostname }} agent token"
    policies:
      - id: consul_acl_agent_policy_output.policy.id
    local: true
    state: present
    mgmt_token: "{{ consul_acl_initial_management_token }}"

- name: Create a policy to allow DNS queries and service lookups
  consul_acl_policy:
    name: "dns-requests"
    rules: |
      node_prefix "" {
        policy = "read"
      }
      service_prefix "" {
        policy = "read"
      }
    datacenters:
      - "{{ consul_datacenter }}"
    state: present
    mgmt_token: "{{ consul_acl_initial_management_token }}"
  register: consul_acl_dns_policy_output

- name: Create an anonymous token
  consul_acl_token:
    secret_id: anonymous
    description: "Anonymous Token"
    policies:
      - id: consul_acl_dns_policy_output.policy.id
    state: present
    mgmt_token: "{{ consul_acl_initial_management_token }}"
